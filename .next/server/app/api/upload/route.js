"use strict";(()=>{var e={};e.id=5998,e.ids=[5998],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},1017:e=>{e.exports=require("path")},3932:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>_,originalPathname:()=>E,patchFetch:()=>I,requestAsyncStorage:()=>T,routeModule:()=>w,serverHooks:()=>D,staticGenerationAsyncStorage:()=>v,staticGenerationBailout:()=>A});var a={};r.r(a),r.d(a,{POST:()=>h,PUT:()=>k});var s=r(5419),o=r(9108),i=r(9678),n=r(8070);let c=require("fs/promises");var l=r(1017),u=r.n(l);let p={maxFileSize:5242880,allowedTypes:{images:["image/jpeg","image/jpg","image/png","image/gif","image/webp"],documents:["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],spreadsheets:["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],presentations:["application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"]},paths:{products:"products/",news:"news/",events:"events/",documents:"documents/",temp:"temp/"}};function d(e,t){let r=[];e.size>p.maxFileSize&&r.push(`Dosya boyutu ${p.maxFileSize/1048576}MB'dan b\xfcy\xfck olamaz`),(t||[...p.allowedTypes.images,...p.allowedTypes.documents,...p.allowedTypes.spreadsheets,...p.allowedTypes.presentations]).includes(e.type)||r.push("Desteklenmeyen dosya t\xfcr\xfc");let a=e.name.split(".").pop()?.toLowerCase()||"";return{isValid:0===r.length,errors:r,fileInfo:{name:e.name,size:e.size,type:e.type,extension:a}}}function m(e,t=""){let r=Date.now(),a=Math.random().toString(36).substring(2,8),s=e.split(".").pop(),o=e.split(".").slice(0,-1).join(".").toLowerCase().replace(/[^a-z0-9]/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");return`${t}${r}-${a}-${o}.${s}`}async function f(e,t,r,a,s){try{let o=a||m(t.name),i=`${r}${o}`,n=await t.arrayBuffer();await e.put(i,n,{httpMetadata:{contentType:t.type,contentDisposition:`inline; filename="${t.name}"`},customMetadata:{originalName:t.name,uploadedAt:new Date().toISOString(),size:t.size.toString(),mimeType:t.type,uploadedBy:s||"system"}});let c=`https://pub-94c47ebc7b14458eb1e09b63a8768d72.r2.dev/${i}`;return{success:!0,url:c,key:i}}catch(e){return console.error("R2 upload error:",e),{success:!1,error:e instanceof Error?e.message:"Upload failed"}}}var y=r(2002);function g(e){return e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown"}async function h(e){try{let t;let r=e.cookies.get("accessToken")?.value||e.headers.get("authorization")?.replace("Bearer ","");if(!r)return n.Z.json({success:!1,error:"Kimlik doğrulama gerekli",code:"AUTHENTICATION_REQUIRED"},{status:401});let a=await y.e8.verifyAccessToken(r);if(!a.success)return n.Z.json({success:!1,error:"Ge\xe7ersiz kimlik doğrulama",code:"INVALID_TOKEN"},{status:401});let s=await e.formData(),o=s.get("file"),i=s.get("type")||"products",l=s.get("filename");if(!o)return n.Z.json({success:!1,error:"Dosya bulunamadı",code:"NO_FILE"},{status:400});let h=d(o);if(!h.isValid)return n.Z.json({success:!1,error:h.errors.join(", "),code:"VALIDATION_FAILED"},{status:400});if(!Object.keys(p.paths).includes(i))return n.Z.json({success:!1,error:"Ge\xe7ersiz upload tipi",code:"INVALID_UPLOAD_TYPE"},{status:400});let k=l||m(o.name),w=p.paths[i],T=process.env.UPLOADS;if(T){let e=await f(T,o,w,k,a.user?.username);if(!e.success)return n.Z.json({success:!1,error:`R2 upload failed: ${e.error}`,code:"R2_UPLOAD_ERROR"},{status:500});t=e.url}else{let e=u().join(process.cwd(),"public","uploads",w);await (0,c.mkdir)(e,{recursive:!0});let r=await o.arrayBuffer(),a=Buffer.from(r),s=u().join(e,k);await (0,c.writeFile)(s,a),t=`/uploads/${w}${k}`}return console.log(`File uploaded: ${k} by user ${a.user?.username} from IP ${g(e)}`),n.Z.json({success:!0,data:{url:t,filename:k,originalName:o.name,size:o.size,type:o.type,uploadType:i},message:"Dosya başarıyla y\xfcklendi"})}catch(e){return console.error("Upload error:",e),n.Z.json({success:!1,error:"Dosya y\xfcklenirken hata oluştu",code:"UPLOAD_ERROR"},{status:500})}}async function k(e){try{let t=e.cookies.get("accessToken")?.value||e.headers.get("authorization")?.replace("Bearer ","");if(!t)return n.Z.json({success:!1,error:"Kimlik doğrulama gerekli",code:"AUTHENTICATION_REQUIRED"},{status:401});let r=await y.e8.verifyAccessToken(t);if(!r.success)return n.Z.json({success:!1,error:"Ge\xe7ersiz kimlik doğrulama",code:"INVALID_TOKEN"},{status:401});let a=await e.formData(),s=a.getAll("files"),o=a.get("type")||"products";if(!s||0===s.length)return n.Z.json({success:!1,error:"Dosya bulunamadı",code:"NO_FILES"},{status:400});if(!Object.keys(p.paths).includes(o))return n.Z.json({success:!1,error:"Ge\xe7ersiz upload tipi",code:"INVALID_UPLOAD_TYPE"},{status:400});let i=[],l=[],f=p.paths[o],h=u().join(process.cwd(),"public","uploads",f);await (0,c.mkdir)(h,{recursive:!0});for(let e=0;e<s.length;e++){let t=s[e];try{let r=d(t);if(!r.isValid){l.push(`${t.name}: ${r.errors.join(", ")}`);continue}let a=m(t.name,`batch-${e}-`),s=await t.arrayBuffer(),o=Buffer.from(s),n=u().join(h,a);await (0,c.writeFile)(n,o);let p=`/uploads/${f}${a}`;i.push({url:p,filename:a,originalName:t.name,size:t.size,type:t.type})}catch(e){console.error(`Error uploading file ${t.name}:`,e),l.push(`${t.name}: Y\xfckleme hatası`)}}return console.log(`Batch upload: ${i.length} files uploaded by user ${r.user?.username} from IP ${g(e)}`),n.Z.json({success:!0,data:{uploadedFiles:i,totalUploaded:i.length,totalRequested:s.length,errors:l.length>0?l:void 0},message:`${i.length}/${s.length} dosya başarıyla y\xfcklendi`})}catch(e){return console.error("Multiple upload error:",e),n.Z.json({success:!1,error:"Dosyalar y\xfcklenirken hata oluştu",code:"BATCH_UPLOAD_ERROR"},{status:500})}}let w=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/upload/route",pathname:"/api/upload",filename:"route",bundlePath:"app/api/upload/route"},resolvedPagePath:"/Users/denizhan/Documents/Windsurf/protekanalitik/src/app/api/upload/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:T,staticGenerationAsyncStorage:v,serverHooks:D,headerHooks:_,staticGenerationBailout:A}=w,E="/api/upload/route";function I(){return(0,i.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:v})}},2002:(e,t,r)=>{r.d(t,{e8:()=>p,pS:()=>u});var a=r(9616),s=r(1865);r(7529);var o=r(6176);let i=process.env.JWT_SECRET||"your-super-secret-jwt-key-change-in-production",n=process.env.JWT_ACCESS_EXPIRES_IN||"15m",c=process.env.JWT_REFRESH_EXPIRES_IN||"7d";class l{static getSecret(){return new TextEncoder().encode(i)}static async generateAccessToken(e){let t={sub:e.id,username:e.username,email:e.email,role:e.role,type:"access"};return await new a.N(t).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime(n).sign(this.getSecret())}static async generateRefreshToken(e){let t={sub:e.id,username:e.username,email:e.email,role:e.role,type:"refresh"};return await new a.N(t).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime(c).sign(this.getSecret())}static async verifyToken(e){try{let{payload:t}=await (0,s._)(e,this.getSecret());return{success:!0,payload:t}}catch(e){return{success:!1,error:e.message||"Invalid token"}}}}class u{static{this.attempts=new Map}static isRateLimited(e,t=5,r=9e5){let a=Date.now(),s=this.attempts.get(e);return!s||a>s.resetTime?(this.attempts.set(e,{count:1,resetTime:a+r}),!1):s.count>=t||(s.count++,!1)}static clearAttempts(e){this.attempts.delete(e)}static resetRateLimit(e){this.attempts.delete(e)}static cleanup(){let e=Date.now(),t=[];this.attempts.forEach((r,a)=>{e>r.resetTime&&t.push(a)}),t.forEach(e=>{this.attempts.delete(e)})}}class p{static async authenticate(e,t){try{if("protekadmin"!==e&&"admin@protekanalitik.com"!==e||"protek1234"!==t)return{success:!1,error:"Ge\xe7ersiz kullanıcı adı veya şifre"};{let e={id:"admin-001",username:"protekadmin",email:"admin@protekanalitik.com",first_name:"Admin",last_name:"User",role:"admin",is_active:!0,last_login:o.l3.formatDate(),created_at:o.l3.formatDate(),updated_at:o.l3.formatDate()},t=await l.generateAccessToken(e),r=await l.generateRefreshToken(e);return{success:!0,user:e,accessToken:t,refreshToken:r}}}catch(e){return console.error("Authentication error:",e),{success:!1,error:"Kimlik doğrulama sırasında hata oluştu"}}}static async refreshAccessToken(e){try{let t=await l.verifyToken(e);if(!t.success||!t.payload)return{success:!1,error:"Ge\xe7ersiz refresh token"};if("refresh"!==t.payload.type)return{success:!1,error:"Ge\xe7ersiz token tipi"};let r={id:t.payload.sub,username:t.payload.username,email:t.payload.email,role:t.payload.role,is_active:!0,created_at:o.l3.formatDate(),updated_at:o.l3.formatDate()},a=await l.generateAccessToken(r);return{success:!0,user:r,accessToken:a,refreshToken:e}}catch(e){return console.error("Token refresh error:",e),{success:!1,error:"Token yenileme sırasında hata oluştu"}}}static async verifyAccessToken(e){try{let t=await l.verifyToken(e);if(!t.success||!t.payload)return{success:!1,error:"Ge\xe7ersiz token"};if("access"!==t.payload.type)return{success:!1,error:"Ge\xe7ersiz token tipi"};let r={id:t.payload.sub,username:t.payload.username,email:t.payload.email,role:t.payload.role,is_active:!0,created_at:o.l3.formatDate(),updated_at:o.l3.formatDate()};return{success:!0,user:r}}catch(e){return console.error("Token verification error:",e),{success:!1,error:"Token doğrulama sırasında hata oluştu"}}}static hasRole(e,t){let r={viewer:1,editor:2,admin:3,super_admin:4};return r[e.role]>=r[t]}static async generatePasswordResetToken(e){let t={sub:e,type:"password_reset",exp:Math.floor(Date.now()/1e3)+3600};return await new a.N(t).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("1h").sign(l.getSecret())}static async verifyPasswordResetToken(e){try{let t=await l.verifyToken(e);if(!t.success||!t.payload||"password_reset"!==t.payload.type)return{success:!1,error:"Ge\xe7ersiz şifre sıfırlama token"};return{success:!0,userId:t.payload.sub}}catch(e){return console.error("Password reset token verification error:",e),{success:!1,error:"Token doğrulama sırasında hata oluştu"}}}}},6176:(e,t,r)=>{r.d(t,{l3:()=>a,v$:()=>s});let a={generateId:()=>crypto.randomUUID(),toJson:e=>JSON.stringify(e),fromJson:e=>{if(!e)return null;try{return JSON.parse(e)}catch{return null}},generateSlug:e=>e.toLowerCase().replace(/ğ/g,"g").replace(/ü/g,"u").replace(/ş/g,"s").replace(/ı/g,"i").replace(/ö/g,"o").replace(/ç/g,"c").replace(/[^a-z0-9]/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,""),formatDate:(e=new Date)=>e.toISOString(),getPaginationParams:(e=1,t=20)=>({limit:t,offset:(e-1)*t})},s={isValidEmail:e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),isValidPhone:e=>/^[\+]?[0-9\s\-\(\)]{10,}$/.test(e),isValidUrl:e=>{try{return new URL(e),!0}catch{return!1}},sanitizeHtml:e=>e.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi,"").replace(/on\w+="[^"]*"/gi,"")}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,5669],()=>r(3932));module.exports=a})();